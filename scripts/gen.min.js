function getNewChart(e,t,n,$){var r=[],a=!1;return $.forEach(($,l)=>{l<t||l>n?r.push($):a||(e.addCommas().forEach((e,t)=>{r.push(e)}),a=!0)}),r.join("\n")}function removeJacks(e){for(let t=0;t<e.length;t++)e[t]==e[t+1]&&(e.splice(t,1),t--);return e}function findFirstArrow(e,t){for(let n=t;n>0&&!["1000","3000","1100","3300","1010","3030"].includes(e[n]);n--){if(["0001","0003","0011","0033","0101","0303"].includes(e[n]))return"L";if(["0100","0010","0300","0030"].includes(e[n])){patt=[e[n]];for(let $=--n;$>0;$--)if(["0100","0010"].includes(e[$])&&patt.unshift(e[$]),["1000","0001"].includes(e[$])){if(patt.unshift(e[$]),(patt=removeJacks(patt)).length%2&&"1000"==patt[0])return"R";if(patt.length%2&&"0001"==patt[0])return"L";if(!(patt.length%2)&&"0001"==patt[0])return"R";if(!(patt.length%2)&&"1000"==patt[0])return"L"}}}return"R"}function getMeasure(e,t){var n,$,r=[];for(let a=t;a>0;a--)if(","==e[a]||":"==e[a].slice(-1)){n=a+1;break}for(let l=t;l<e.length;l++)if(","==e[l]||";"==e[l]){$=l-1;break}for(let i=n;i<=$;i++)r.push(e[i]);return r}function findStreamBegin(e,t){for(let n=t;n>0;n--)if(","==e[n]||":"==e[n].slice(-1))return n+1}function findStreamEnd(e,t){for(let n=t;n<e.length;n++)if(","==e[n]||";"==e[n])return n-1}function noPlagiarism(e){lines=e.split("\n");for(let t=0;t<lines.length;t++)"#NOTES:"==lines[t]&&(stepArtist=lines[t+2].match(/[ a-z]*/i),lines[t+2]=stepArtist+", itg-stream-autogen:");return lines.join("\n")}function main(e,t){e=noPlagiarism(e);do{noMoreStreams=!0,lines=e.split("\n");var n,$,r=0,a=0,l=0,i=!1,u="";for(let o=0;o<lines.length;o++){var f=lines[o];if(("2222"==f||"4444"==f)&&(t.quantization="2"==f[0]?t.quantHolds:t.quantRolls,a=findStreamBegin(lines,o),u=findFirstArrow(lines,o),n=getMeasure(lines,o),noMoreStreams=!1,i=!0),i&&o>=a&&(","==f&&r++,"3333"==f)){r++,l=findStreamEnd(lines,o),$=getMeasure(lines,o),i=!1;break}}noMoreStreams||(stream=new StreamBlock(r,t.quantization,u,n,$),(gen=new Generator(stream,t)).generateStream(),e=getNewChart(stream,a,l,lines))}while(!noMoreStreams);var s=new Blob([e],{type:"text/plain"}),d=new File([s],"output.sm",{type:"text/plain"});let c=document.createElement("a");c.style.display="none",c.href=URL.createObjectURL(d),c.download=d.name,document.body.appendChild(c),c.click()}function seParti(){var e=document.getElementById("chart").files[0],t=document.getElementById("holds-quant").value,n=document.getElementById("rolls-quant").value,$=document.getElementById("customquant-holds").value,r=document.getElementById("customquant-rolls").value,a=document.getElementById("candles").value;$&&0!=$&&(t=$),r&&0!=r&&(n=r);var l={quantHolds:t,quantRolls:n,candleDens:a,wtfMode:0==a},i=new FileReader;i.onload=function(e){main(e.target.result,l)},i.readAsText(e)}
