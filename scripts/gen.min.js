function getNewChart(e,n,t,$){var r=[],l=!1;return $.forEach(($,a)=>{a<n||a>t?r.push($):l||(e.addCommas().forEach((e,n)=>{r.push(e)}),l=!0)}),r.join("\n")}function removeJacks(e){for(let n=0;n<e.length;n++)e[n]==e[n+1]&&(e.splice(n,1),n--);return e}function findFirstArrow(e,n){for(let t=n;t>0&&!["1000","3000","1100","3300","1010","3030"].includes(e[t]);t--){if(["0001","0003","0011","0033","0101","0303"].includes(e[t]))return"L";if(["0100","0010","0300","0030"].includes(e[t])){patt=[e[t]];for(let $=--t;$>0;$--)if(["0100","0010","0300","0030"].includes(e[$])&&patt.unshift(e[$]),["1000","0001","3000","0003"].includes(e[$])){if(patt.unshift(e[$]),(patt=removeJacks(patt)).length%2&&["1000","3000"].includes(patt[0]))return"R";if(patt.length%2&&["0001","0003"].includes(patt[0]))return"L";if(!(patt.length%2)&&["0001","0003"].includes(patt[0]))return"R";if(!(patt.length%2)&&["1000","3000"].includes(patt[0]))return"L"}}}return"R"}function getMeasure(e,n){var t,$,r=[];for(let l=n;l>0;l--)if(","==e[l]||":"==e[l].slice(-1)){t=l+1;break}for(let a=n;a<e.length;a++)if(","==e[a]||";"==e[a]){$=a-1;break}for(let i=t;i<=$;i++)r.push(e[i]);return r}function findStreamBegin(e,n){for(let t=n;t>0;t--)if(","==e[t]||":"==e[t].slice(-1))return t+1}function findStreamEnd(e,n){for(let t=n;t<e.length;t++)if(","==e[t]||";"==e[t])return t-1}function noPlagiarism(e){lines=e.split("\n");for(let n=0;n<lines.length;n++)"#NOTES:"==lines[n]&&(stepArtist=lines[n+2].match(/[ a-z]*/i),lines[n+2]=stepArtist+", itg-stream-autogen:");return lines.join("\n")}function main(e,n){e=noPlagiarism(e);do{noMoreStreams=!0,lines=e.split("\n");var t,$,r=0,l=0,a=0,i=!1,u="";for(let o=0;o<lines.length;o++){var s=lines[o];if(("2222"==s||"4444"==s)&&(n.quantization="2"==s[0]?n.quantHolds:n.quantRolls,l=findStreamBegin(lines,o),u=findFirstArrow(lines,o),t=getMeasure(lines,o),noMoreStreams=!1,i=!0),i&&o>=l&&(","==s&&r++,"3333"==s)){r++,a=findStreamEnd(lines,o),$=getMeasure(lines,o),i=!1;break}}noMoreStreams||(stream=new StreamBlock(r,n.quantization,u,t,$),(gen=new Generator(stream,n)).generateStream(),e=getNewChart(stream,l,a,lines))}while(!noMoreStreams);var f=new Blob([e],{type:"text/plain"}),d=new File([f],"output.sm",{type:"text/plain"});let c=document.createElement("a");c.style.display="none",c.href=URL.createObjectURL(d),c.download=d.name,document.body.appendChild(c),c.click()}function seParti(){var e=document.getElementById("chart").files[0],n=document.getElementById("holds-quant").value,t=document.getElementById("rolls-quant").value,$=document.getElementById("customquant-holds").value,r=document.getElementById("customquant-rolls").value,l=document.getElementById("candles").value,a=document.getElementById("anchors").value;$&&0!=$&&(n=$),r&&0!=r&&(t=r);var i={quantHolds:n,quantRolls:t,candleDens:l,anchorDens:a,wtfMode:0==l},u=new FileReader;u.onload=function(e){main(e.target.result,i)},u.readAsText(e)}