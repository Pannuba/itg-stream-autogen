const startFromLeftPatterns={LDUR:25,LUDR:25,LDUDL:6,LUDUL:6,LUL:19,LDL:19},startFromRightPatterns={RUDL:25,RDUL:25,RUDUR:6,RDUDR:6,RUR:19,RDR:19},rightFacingPatterns=["LDUR","LDL","RUR","RUDL","LDUDL","RUDUR"],leftFacingPatterns=["RDUL","RDR","LUL","LUDR","RDUDR","LUDUL"],candleDownDict={D:10,DU:80,DUD:10},candleUpDict={U:10,UD:80,UDU:10},arrowsDict={L:"1000",D:"0100",U:"0010",R:"0001"};class Generator{constructor(t,r){this.stream=t,this.options=r}generateStream(){var t=this.stream.measures*this.options.quantization;for(this.addNonCandle();t>0;)Math.floor(Math.random()*this.options.candleDens)?this.addNonCandle():this.addCandle(),t-=this.stream.lastPatterns[0].length;return stream}addNonCandle(){var t="";if(Math.floor(Math.random()*this.options.anchorDens))do t=this.chooseNextPattern("L"==this.stream.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(this.stream.lastPatterns.includes(t));else{"L"==this.stream.nextArrow?(this.stream.arrows.push("1000"),this.stream.nextArrow="R"):(this.stream.arrows.push("0001"),this.stream.nextArrow="L");do t=this.chooseNextPattern("L"==this.stream.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(this.stream.lastPatterns.includes(t)||3==t.length)}if((rightFacingPatterns.includes(t)&&this.stream.lastDirections.every(t=>"R"==t)||leftFacingPatterns.includes(t)&&this.stream.lastDirections.every(t=>"L"==t))&&(t=this.mirrorVertically(t)),5!=t.length||Math.floor(Math.random()*this.options.anchorDens)){if(4==t.length&&!Math.floor(12*Math.random())){this.processPattern(t,stream),this.stream.arrows.pop();var r=rightFacingPatterns.includes(t)?"R":"L";do t=this.chooseNextPattern("R"==this.stream.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(4!=t.length||r!=(rightFacingPatterns.includes(t)?"R":"L"))}}else{this.processPattern(t,stream),this.stream.arrows.pop();var r=rightFacingPatterns.includes(t)?"R":"L";do t=this.chooseNextPattern("R"==this.stream.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(4!=t.length||r!=(rightFacingPatterns.includes(t)?"R":"L"))}return this.processPattern(t,stream),stream}addCandle(){var t,r="";if(t="U"==this.stream.lastPatterns[0].slice(-2,-1)?this.chooseNextPattern(candleDownDict):this.chooseNextPattern(candleUpDict),this.convertPatternToList(t).forEach(t=>{this.stream.arrows.push(t)}),2==t.length){if(Math.floor(4*Math.random())&&!this.options.wtfMode){do r=this.chooseNextPattern("L"==this.stream.nextArrow?startFromRightPatterns:startFromLeftPatterns);while(r[1]+r[2]==t&&4==r.length);this.stream.arrows.push("L"==this.stream.nextArrow?"1000":"0001")}else do r=this.chooseNextPattern("L"==this.stream.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(r[1]==t[1])}else if(Math.floor(Math.random()*this.options.anchorDens))do r=this.chooseNextPattern("L"==this.stream.nextArrow?startFromRightPatterns:startFromLeftPatterns);while(3==t.length&&r[1]==t[2]||1==t.length&&(3==r.length||r[1]==t));else do r=this.chooseNextPattern("L"==this.stream.nextArrow?startFromRightPatterns:startFromLeftPatterns);while(3==t.length&&(r[1]!=t[2]||4!=r.length)||1==t.length&&(3!=r.length||r[1]==t));return this.processPattern(r,stream),stream}mirrorVertically(t){return t.replaceAll("U","X").replaceAll("D","U").replaceAll("X","D")}processPattern(t){this.stream.lastPatterns.unshift(t),this.stream.lastPatterns.pop(),this.stream.lastDirections.unshift(rightFacingPatterns.includes(t)?"R":"L"),this.stream.lastDirections.pop(),"R"==t.slice(-1)?this.stream.nextArrow="L":this.stream.nextArrow="R",this.convertPatternToList(t).forEach(t=>{this.stream.arrows.push(t)})}chooseNextPattern(t){var r=Math.floor(99*Math.random());for(let[e,s]of Object.entries(t)){if(r<s)return e;r-=s}return null}convertPatternToList(t){var r=[];for(let e of t)r.push(arrowsDict[e]);return r}}