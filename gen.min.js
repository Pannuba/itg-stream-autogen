const nextArrowLeftPatterns=["LDUR","LUDR","RUDUR","RDUDR","RUR","RDR"],nextArrowRightPatterns=["RUDL","RDUL","LDUDL","LUDUL","LUL","LDL"],startFromLeftPatterns={LDUR:29,LUDR:29,LDUDL:3,LUDUL:3,LUL:18,LDL:18},startFromRightPatterns={RUDL:29,RDUL:29,RUDUR:3,RDUDR:3,RUR:18,RDR:18},candleDownDict={D:40,DU:50,DUD:10},candleUpDict={U:40,UD:50,UDU:10},arrowsDict={L:"1000",D:"0100",U:"0010",R:"0001"};var lastPatterns=["X","X"];function generateStream(t,e,r,n){for(stream=new StreamBlock(t,e,n),arrowsToGenerate=t*e,addPattern(!0,stream);arrowsToGenerate>0;)arrowsToGenerate-=(stream=addPattern(Math.floor(Math.random()*r),stream)).lastPattern.length;return stream}function addPattern(t=!0,e){if(t)do pattern=chooseNextPattern("L"==e.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(lastPatterns.includes(pattern));else{var r;if(convertPatternToList(r="U"==e.lastPattern.slice(-2,-1)?chooseNextPattern(candleDownDict):chooseNextPattern(candleUpDict)).forEach(t=>{e.arrows.push(t)}),2==r.length)do pattern=chooseNextPattern(nextArrowLeftPatterns.includes(e.lastPattern)?startFromLeftPatterns:startFromRightPatterns);while(pattern[1]==r[1]);else do pattern=chooseNextPattern(nextArrowLeftPatterns.includes(e.lastPattern)?startFromRightPatterns:startFromLeftPatterns);while(pattern[1]==r.slice(-1))}return e.lastPattern=pattern,lastPatterns.unshift(pattern),lastPatterns.pop(),"R"==pattern.slice(-1)?e.nextArrow="L":e.nextArrow="R",convertPatternToList(pattern).forEach(t=>{e.arrows.push(t)}),e}function chooseNextPattern(t){var e=Math.floor(99*Math.random());for(let[r,n]of Object.entries(t)){if(e<n)return r;e-=n}}function convertPatternToList(t){var e=[];for(let r of t)e.push(arrowsDict[r]);return e}function getNewChart(t,e,r,n){var a=[];streamLineCounter=0;var $=!1;return n.forEach((n,o)=>{o<e||o>r-1?a.push(n):$||(t.addCommas().forEach((t,e)=>{a.push(t)}),$=!0)}),a.join("\n")}function findFirstArrow(t,e){for(let r=e;r>0&&!["1000","1100","1010"].includes(t[r]);r--){if(["0001","0011","0101"].includes(t[r]))return"L";if("0010"==t[r]||"0100"==t[r]){patt=[t[r]];for(let n=--r;n>0;n--)if(["0100","0010"].includes(t[n])&&patt.unshift(t[n]),["1000","0001"].includes(t[n])){if(patt.unshift(t[n]),patt.length%2&&"1000"==patt[0])return"R";if(patt.length%2&&"0001"==patt[0])return"L";if(!(patt.length%2)&&"0001"==patt[0])return"R";if(!(patt.length%2)&&"1000"==patt[0])return"L"}}}return"R"}function findStreamBegin(t,e){var r=!1;for(let n=e-1;n>0&&","!=t[n];n--)if("0000"!=t[n]){r=!0;break}if(r){t[e]="0000";var a=0;for(let $=e;","!=t[$];$++)a++;streamBegin=e+ ++a}else{t[e]="0000";var a=0;for(let o=e-1;","!=t[o];--o)a++;streamBegin=e-a}return streamBegin}function findStreamEnd(t,e){streamEnd=e,t[e]="0000";var r=0;for(let n=e-1;n>0;n--){if(","==t[n]){streamEnd-=r;break}r++}return streamEnd}function main(t,e=16,r=8){do{noMoreStreams=!0,lines=t.split("\n");var n=0,a=0,$=0,o=!1,s="";for(let i=0;i<lines.length;i++){var l=lines[i];if("2222"==l&&(a=findStreamBegin(lines,i),s=findFirstArrow(lines,i),noMoreStreams=!1,o=!0),o&&i>=a&&(","==l&&n++,"3333"==l)){$=findStreamEnd(lines,i,n),o=!1;break}}noMoreStreams||(t=getNewChart(stream=generateStream(n,e,r,s),a,$,lines))}while(!noMoreStreams);var f=new Blob([t],{type:"text/plain"}),c=new File([f],"output.sm",{type:"text/plain"});let u=document.createElement("a");u.style.display="none",u.href=URL.createObjectURL(c),u.download=c.name,document.body.appendChild(u),u.click()}function seParti(){var t=document.getElementById("chart").files[0],e=document.getElementById("quantization").value,r=document.getElementById("customquant").value,n=document.getElementById("candles").value;r&&0!=r&&(e=r);var a=new FileReader;a.onload=function(t){main(t.target.result,e,n)},a.readAsText(t)}
