const nextArrowLeftPatterns=["LDUR","LUDR","RUDUR","RDUDR","RUR","RDR","RDULUDR","RUDLDUR"],nextArrowRightPatterns=["RUDL","RDUL","LDUDL","LUDUL","LUL","LDL","LDURUDL","LUDRDUL"],startFromLeftPatterns={LDUR:25,LUDR:25,LDUDL:6,LUDUL:6,LUL:17,LDL:17,LDURUDL:2,LUDRDUL:2},startFromRightPatterns={RUDL:25,RDUL:25,RUDUR:6,RDUDR:6,RUR:17,RDR:17,RDULUDR:2,RUDLDUR:2},candleDownDict={D:10,DU:80,DUD:10},candleUpDict={U:10,UD:80,UDU:10},arrowsDict={L:"1000",D:"0100",U:"0010",R:"0001"};var lastPatterns=["X","X"];function generateStream(t,e){for(arrowsToGenerate=t.measures*e.quantization,addPattern(!0,t);arrowsToGenerate>0;)arrowsToGenerate-=(t=addPattern(Math.floor(Math.random()*e.candleDens),t,e)).lastPattern.length;return t}function addPattern(t=!0,e,r){var n,a="";if(t)do a=chooseNextPattern("L"==e.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(lastPatterns.includes(a));else if(convertPatternToList(n="U"==e.lastPattern.slice(-2,-1)?chooseNextPattern(candleDownDict):chooseNextPattern(candleUpDict)).forEach(t=>{e.arrows.push(t)}),2==n.length){if(Math.floor(4*Math.random())&&!r.wtfMode){do a=nextArrowLeftPatterns.includes(e.lastPattern)?chooseNextPattern(startFromRightPatterns):chooseNextPattern(startFromLeftPatterns);while(a[1]+a[2]==n&&(4==a.length||7==a.length));e.arrows.push(nextArrowLeftPatterns.includes(e.lastPattern)?"1000":"0001")}else do a=chooseNextPattern(nextArrowLeftPatterns.includes(e.lastPattern)?startFromLeftPatterns:startFromRightPatterns);while(a[1]==n[1])}else do a=chooseNextPattern(nextArrowLeftPatterns.includes(e.lastPattern)?startFromRightPatterns:startFromLeftPatterns);while(a[1]==n.slice(-1));return e.lastPattern=a,lastPatterns.unshift(a),lastPatterns.pop(),"R"==a.slice(-1)?e.nextArrow="L":e.nextArrow="R",convertPatternToList(a).forEach(t=>{e.arrows.push(t)}),e}function chooseNextPattern(t){var e=Math.floor(99*Math.random());for(let[r,n]of Object.entries(t)){if(e<n)return r;e-=n}}function convertPatternToList(t){var e=[];for(let r of t)e.push(arrowsDict[r]);return e}function getNewChart(t,e,r,n){var a=[],o=!1;return n.forEach((n,s)=>{s<e||s>r?a.push(n):o||(t.addCommas().forEach((t,e)=>{a.push(t)}),o=!0)}),a.join("\n")}function removeJacks(t){for(let e=0;e<t.length;e++)t[e]==t[e+1]&&(t.splice(e,1),e--);return t}function findFirstArrow(t,e){for(let r=e;r>0&&!["1000","3000","1100","3300","1010","3030"].includes(t[r]);r--){if(["0001","0003","0011","0033","0101","0303"].includes(t[r]))return"L";if(["0100","0010","0300","0030"].includes(t[r])){patt=[t[r]];for(let n=--r;n>0;n--)if(["0100","0010"].includes(t[n])&&patt.unshift(t[n]),["1000","0001"].includes(t[n])){if(patt.unshift(t[n]),(patt=removeJacks(patt)).length%2&&"1000"==patt[0])return"R";if(patt.length%2&&"0001"==patt[0])return"L";if(!(patt.length%2)&&"0001"==patt[0])return"R";if(!(patt.length%2)&&"1000"==patt[0])return"L"}}}return"R"}function getMeasure(t,e){var r,n,a=[];for(let o=e;o>0;o--)if(","==t[o]||":"==t[o].slice(-1)){r=o+1;break}for(let s=e;s<t.length;s++)if(","==t[s]||";"==t[s]){n=s-1;break}for(let $=r;$<=n;$++)a.push(t[$]);return a}function findStreamBegin(t,e){for(let r=e;r>0;r--)if(","==t[r]||":"==t[r].slice(-1))return r+1}function findStreamEnd(t,e){for(let r=e;r<t.length;r++)if(","==t[r]||";"==t[r])return r-1}function noPlagiarism(t){lines=t.split("\n");for(let e=0;e<lines.length;e++)"#NOTES:"==lines[e]&&(stepArtist=lines[e+2].match(/[ a-z]*/i),lines[e+2]=stepArtist+", itg-stream-autogen:");return lines.join("\n")}function main(t,e){t=noPlagiarism(t);do{noMoreStreams=!0,lines=t.split("\n");var r,n,a=0,o=0,s=0,$=!1,l="";for(let i=0;i<lines.length;i++){var u=lines[i];if(("2222"==u||"4444"==u)&&(e.quantization="2"==u[0]?e.quantHolds:e.quantRolls,o=findStreamBegin(lines,i),l=findFirstArrow(lines,i),r=getMeasure(lines,i),noMoreStreams=!1,$=!0),$&&i>=o&&(","==u&&a++,"3333"==u)){a++,s=findStreamEnd(lines,i),n=getMeasure(lines,i),$=!1;break}}noMoreStreams||(generateStream(stream=new StreamBlock(a,e.quantization,l,r,n),e),t=getNewChart(stream,o,s,lines))}while(!noMoreStreams);var f=new Blob([t],{type:"text/plain"}),c=new File([f],"output.sm",{type:"text/plain"});let d=document.createElement("a");d.style.display="none",d.href=URL.createObjectURL(c),d.download=c.name,document.body.appendChild(d),d.click()}function seParti(){var t=document.getElementById("chart").files[0],e=document.getElementById("holds-quant").value,r=document.getElementById("rolls-quant").value,n=document.getElementById("customquant-holds").value,a=document.getElementById("customquant-rolls").value,o=document.getElementById("candles").value;n&&0!=n&&(e=n),a&&0!=a&&(r=a);var s={quantHolds:e,quantRolls:r,candleDens:o,wtfMode:0==o},$=new FileReader;$.onload=function(t){main(t.target.result,s)},$.readAsText(t)}
