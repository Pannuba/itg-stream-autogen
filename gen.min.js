const nextArrowLeftPatterns=["LDUR","LUDR","RUDUR","RDUDR","RUR","RDR"],nextArrowRightPatterns=["RUDL","RDUL","LDUDL","LUDUL","LUL","LDL"],startFromLeftPatterns={LDUR:29,LUDR:29,LDUDL:3,LUDUL:3,LUL:18,LDL:18},startFromRightPatterns={RUDL:29,RDUL:29,RUDUR:3,RDUDR:3,RUR:18,RDR:18},candleDownDict={D:40,DU:50,DUD:10},candleUpDict={U:40,UD:50,UDU:10},arrowsDict={L:"1000",D:"0100",U:"0010",R:"0001"};var lastPatterns=["X","X"];function generateStream(t,e,r){for(stream=new StreamBlock(t,e),arrowsToGenerate=t*e,addPattern(!0,stream);arrowsToGenerate>0;)arrowsToGenerate-=(stream=addPattern(Math.floor(Math.random()*r),stream)).lastPattern.length;return stream}function addPattern(t=!0,e){if(t)do pattern=chooseNextPattern("L"==e.nextArrow?startFromLeftPatterns:startFromRightPatterns);while(lastPatterns.includes(pattern));else{var r;if(convertPatternToList(r="U"==e.lastPattern.slice(-2,-1)?chooseNextPattern(candleDownDict):chooseNextPattern(candleUpDict)).forEach(t=>{e.arrows.push(t)}),2==r.length)do pattern=chooseNextPattern(nextArrowLeftPatterns.includes(e.lastPattern)?startFromLeftPatterns:startFromRightPatterns);while(pattern[1]==r[1]);else do pattern=chooseNextPattern(nextArrowLeftPatterns.includes(e.lastPattern)?startFromRightPatterns:startFromLeftPatterns);while(pattern[1]==r.slice(-1))}return e.lastPattern=pattern,lastPatterns.unshift(pattern),lastPatterns.pop(),"R"==pattern.slice(-1)?e.nextArrow="L":e.nextArrow="R",convertPatternToList(pattern).forEach(t=>{e.arrows.push(t)}),e}function chooseNextPattern(t){var e=Math.floor(99*Math.random());for(let[r,a]of Object.entries(t)){if(e<a)return r;e-=a}}function convertPatternToList(t){var e=[];for(let r of t)e.push(arrowsDict[r]);return e}function getNewChart(t,e,r,a){var n=[];streamLineCounter=0;var o=!1;return a.forEach((a,s)=>{s<e||s>r+1?n.push(a):o||(t.addCommas().forEach((t,e)=>{n.push(t)}),o=!0)}),n.join("\n")}function main(t,e=16,r=8){do{noMoreStreams=!0,lines=t.split("\n");var a=0,n=0,o=0,s=!1;for(let[l,i]of lines.entries())if("2222"==i&&(noMoreStreams=!1,s=!0,a+=1,n=l),s&&("0000"==i&&(a+=1),"3333"==i)){o=l,s=!1;break}t=getNewChart(stream=generateStream(measures=a/4,e,r),n,o,lines)}while(!noMoreStreams);var c=new Blob([t],{type:"text/plain"}),D=new File([c],"output.sm",{type:"text/plain"});let L=document.createElement("a");L.style.display="none",L.href=URL.createObjectURL(D),L.download=D.name,document.body.appendChild(L),L.click()}function seParti(){var t=document.getElementById("chart").files[0],e=document.getElementById("quantization").value,r=document.getElementById("customquant").value,a=document.getElementById("candles").value;r&&0!=r&&(e=r);var n=new FileReader;n.onload=function(t){main(t.target.result,e,a)},n.readAsText(t)}
